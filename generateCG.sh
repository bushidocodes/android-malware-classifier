#!/bin/bash
# Takes an optional argument for a root directory builds callgraph for all APKs in current directory or subdirectories
# Requires Androguard to be installed
# See info on the androguard cg command at https://androguard.readthedocs.io/en/latest/tools/androcg.html
# See info on my attempt at BASH concurrency at https://unix.stackexchange.com/questions/103920/parallelize-a-bash-for-loop

generateGML () {
    local sourcePath=$1
    local extension=$2
    echo "Exporting as ${extension}"
    gmlPath=${sourcePath%.*}.${extension}
    echo $gmlPath
    if [ -f $gmlPath ]; then
        echo "$gmlPath already exists! Skipping"
    else 
        echo "Starting $gmlPath"
        androguard --quiet cg $sourcePath -o $gmlPath
        echo "Finished $gmlPath"
    fi

}

if [ $# -lt 2 ]; then
  echo 1>&2 "$0: not enough arguments"
  exit 2
elif [ $# -gt 2 ]; then
  echo 1>&2 "$0: too many arguments"
  exit 2
fi

for apkPath in `find ${1:-'.'} -name "*.apk" -type f`; do
    generateGML "$apkPath" $2 &
done
wait
